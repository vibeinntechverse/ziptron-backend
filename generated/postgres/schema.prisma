// ======================================================
// GENERATOR
// ======================================================
generator postgres_client {
  provider = "prisma-client-js"
  output   = "../../generated/postgres"
}

datasource postgres {
  provider = "postgresql"
  url      = env("DATABASE_URL_POSTGRES")
}

// ======================================================
// GENERATOR & DATASOURCE (Postgres) - OPTIMIZED
// ======================================================

// --- ENUMS ---
enum UserRole {
  USER
  STATION_OWNER
  ADMIN
  SUPPORT
}

enum VehicleType {
  SEDAN
  HATCHBACK
  SUV
  CROSSOVER
  COUPE
}

enum ChargingSessionStatus {
  ONGOING
  COMPLETED
  FAILED
}

enum TransactionType {
  CREDIT
  DEBIT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum ConnectorType {
  CCS2
  TYPE2
  CHADEMO
  GB_T
}

enum ChargingGunStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
  OFFLINE
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// --- MODELS ---
model User {
  id            String   @id @postgres.VarChar(100)
  clerkId       String   @unique @postgres.VarChar(100)
  role          UserRole @default(USER)
  email         String   @unique @postgres.VarChar(255)
  phone         String?  @postgres.VarChar(20)
  walletBalance Decimal  @default(0.0) @postgres.Decimal(12, 2)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now()) @postgres.Timestamptz(3)
  updatedAt     DateTime @updatedAt @postgres.Timestamptz(3)

  vehicles     UserVehicle[]
  transactions Transaction[]
  stations     ChargingStation[] @relation("OwnerStations")
  tickets      Ticket[]
  chats        ChatSession[]

  // Composite indexes for common queries
  @@index([email, isActive])
  @@index([role, isActive])
  @@index([createdAt])
  @@index([phone]) // For phone lookup
  @@map("users")
}

model VehicleCatalog {
  id              Int           @id @default(autoincrement())
  brand           String        @postgres.VarChar(100)
  model           String        @postgres.VarChar(100)
  year            Int           @postgres.SmallInt
  batteryCapacity Float         @postgres.Real
  vehicleType     VehicleType
  isActive        Boolean       @default(true)
  vehicles        UserVehicle[]

  // Indexes for catalog searches and filters
  @@index([brand, model, year])
  @@index([vehicleType, isActive])
  @@index([isActive])
  @@map("vehicle_catalog")
}

model UserVehicle {
  id        String   @id @default(uuid()) @postgres.Uuid
  userId    String   @postgres.VarChar(100)
  catalogId Int
  vehicleNo String   @unique @postgres.VarChar(50)
  nickname  String?  @postgres.VarChar(100)
  createdAt DateTime @default(now()) @postgres.Timestamptz(3)

  user     User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  catalog  VehicleCatalog    @relation(fields: [catalogId], references: [id])
  sessions ChargingSession[]

  // Indexes for user vehicle lookups
  @@index([userId, catalogId])
  @@index([catalogId])
  @@index([createdAt])
  @@map("user_vehicles")
}

model ChargingStation {
  id        String   @id @default(uuid()) @postgres.Uuid
  ownerId   String   @postgres.VarChar(100)
  name      String   @postgres.VarChar(255)
  address   String   @postgres.Text
  latitude  Float    @postgres.DoublePrecision
  longitude Float    @postgres.DoublePrecision
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now()) @postgres.Timestamptz(3)

  owner    User      @relation("OwnerStations", fields: [ownerId], references: [id])
  chargers Charger[]
  tickets  Ticket[]

  // Geospatial and lookup indexes
  @@index([latitude, longitude]) // For proximity searches
  @@index([ownerId, isActive])
  @@index([isActive])
  @@index([name]) // For name searches
  @@map("charging_stations")
}

model Charger {
  id        String   @id @default(uuid()) @postgres.Uuid
  stationId String   @postgres.Uuid
  powerKW   Float    @postgres.Real
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now()) @postgres.Timestamptz(3)

  station ChargingStation @relation(fields: [stationId], references: [id], onDelete: Cascade)
  guns    ChargingGun[]

  // Index for station charger lookups
  @@index([stationId, isActive])
  @@index([powerKW]) // For filtering by power capacity
  @@map("chargers")
}

model ChargingGun {
  id               String            @id @default(uuid()) @postgres.Uuid
  chargerId        String            @postgres.Uuid
  connectorType    ConnectorType
  status           ChargingGunStatus
  pricePerKwh      Decimal           @postgres.Decimal(8, 2)
  lastStatusUpdate DateTime          @default(now()) @postgres.Timestamptz(3)

  charger  Charger           @relation(fields: [chargerId], references: [id], onDelete: Cascade)
  sessions ChargingSession[]

  // Indexes for availability and pricing queries
  @@index([chargerId, status])
  @@index([status, connectorType])
  @@index([connectorType])
  @@index([lastStatusUpdate])
  @@map("charging_guns")
}

model ChargingSession {
  id            String                @id @default(uuid()) @postgres.Uuid
  userVehicleId String                @postgres.Uuid
  gunId         String                @postgres.Uuid
  startTime     DateTime              @default(now()) @postgres.Timestamptz(3)
  endTime       DateTime?             @postgres.Timestamptz(3)
  energyUsed    Float?                @postgres.Real
  totalCost     Decimal?              @postgres.Decimal(12, 2)
  status        ChargingSessionStatus
  createdAt     DateTime              @default(now()) @postgres.Timestamptz(3)

  vehicle UserVehicle @relation(fields: [userVehicleId], references: [id])
  gun     ChargingGun @relation(fields: [gunId], references: [id])

  // Critical indexes for session queries
  @@index([userVehicleId, status])
  @@index([gunId, status])
  @@index([status, startTime])
  @@index([startTime, endTime]) // For time-range queries
  @@index([createdAt])
  @@map("charging_sessions")
}

model Transaction {
  id        String            @id @default(uuid()) @postgres.Uuid
  userId    String            @postgres.VarChar(100)
  amount    Decimal           @postgres.Decimal(12, 2)
  type      TransactionType
  status    TransactionStatus
  reference String?           @postgres.VarChar(255) // Payment gateway reference
  createdAt DateTime          @default(now()) @postgres.Timestamptz(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes for transaction history and reconciliation
  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([createdAt])
  @@index([reference]) // For payment gateway lookups
  @@map("transactions")
}

model Ticket {
  id          String         @id @default(uuid()) @postgres.Uuid
  userId      String         @postgres.VarChar(100)
  stationId   String?        @postgres.Uuid
  subject     String         @postgres.VarChar(255)
  description String         @postgres.Text
  status      TicketStatus   @default(OPEN)
  priority    TicketPriority @default(MEDIUM)
  createdAt   DateTime       @default(now()) @postgres.Timestamptz(3)
  updatedAt   DateTime       @updatedAt @postgres.Timestamptz(3)
  resolvedAt  DateTime?      @postgres.Timestamptz(3)

  user    User             @relation(fields: [userId], references: [id])
  station ChargingStation? @relation(fields: [stationId], references: [id])

  // Indexes for ticket management
  @@index([userId, status])
  @@index([stationId, status])
  @@index([status, priority, createdAt])
  @@index([createdAt])
  @@map("tickets")
}

model ChatSession {
  id        String   @id @default(uuid()) @postgres.Uuid
  userId    String   @postgres.VarChar(100)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now()) @postgres.Timestamptz(3)
  updatedAt DateTime @updatedAt @postgres.Timestamptz(3)

  user User @relation(fields: [userId], references: [id])

  // Indexes for chat session retrieval
  @@index([userId, isActive])
  @@index([createdAt])
  @@map("chat_sessions")
}
