// ======================================================
// GENERATOR & DATASOURCE (MongoDB)
// ======================================================
generator mongo_client {
  provider = "prisma-client"
  output   = "../../generated/mongo"
}

datasource mongo {
  provider = "mongodb"
  url      = env("DATABASE_URL_MONGO")
}

// ---------------- AUDIT LOGS ----------------
model AuditLog {
  id         String   @id @default(auto()) @map("_id") @mongo.ObjectId
  entityType String
  entityId   String
  action     String
  changes    Json?
  userId     String?
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([entityType, entityId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@map("audit_logs")
}

// ---------------- CHAT ----------------
model ChatMessage {
  id        String   @id @default(auto()) @map("_id") @mongo.ObjectId
  sessionId String
  sender    String
  message   String
  metadata  Json?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([sessionId, createdAt(sort: Asc)])
  @@map("chat_messages")
}

// ---------------- TELEMETRY ----------------
model TelemetryLog {
  id        String   @id @default(auto()) @map("_id") @mongo.ObjectId
  sessionId String
  gunId     String
  voltage   Float
  current   Float
  power     Float
  soc       Int
  temp      Float?
  errorCode String?
  timestamp DateTime @default(now())

  @@index([sessionId, timestamp(sort: Desc)])
  @@index([gunId, timestamp(sort: Desc)])
  @@map("telemetry_logs")
}

// ---------------- SESSION ANALYTICS ----------------
model SessionAnalytics {
  id         String   @id @default(auto()) @map("_id") @mongo.ObjectId
  sessionId  String   @unique
  userId     String
  stationId  String
  gunId      String
  duration   Int
  energyUsed Float
  avgPower   Float
  peakPower  Float
  errorCount Int
  startTime  DateTime
  endTime    DateTime
  createdAt  DateTime @default(now())

  @@index([stationId, startTime(sort: Desc)])
  @@map("session_analytics")
}

// ---------------- NOTIFICATIONS ----------------
model Notification {
  id        String   @id @default(auto()) @map("_id") @mongo.ObjectId
  userId    String
  type      String
  title     String
  message   String
  data      Json?
  isRead    Boolean  @default(false)
  isSent    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, isRead, createdAt(sort: Desc)])
  @@map("notifications")
}


// ---------------- CHARGER HEARTBEATS ----------------
model ChargerHeartbeat {
  id        String   @id @default(auto()) @map("_id") @mongo.ObjectId
  gunId     String
  stationId String
  status    String        // AVAILABLE | OCCUPIED | OFFLINE | ERROR
  firmware  String?
  latencyMs Int?
  metadata  Json?
  timestamp DateTime @default(now())

  @@index([gunId, timestamp(sort: Desc)])
  @@index([stationId, timestamp(sort: Desc)])
  @@map("charger_heartbeats")
}


// ---------------- GUN STATUS SNAPSHOT ----------------
model GunStatusSnapshot {
  id          String   @id @default(auto()) @map("_id") @mongo.ObjectId
  gunId       String   @unique
  stationId   String
  status      String        // AVAILABLE | OCCUPIED | OFFLINE | MAINTENANCE
  healthScore Float
  lastSeen    DateTime
  updatedAt   DateTime @default(now())

  @@index([stationId])
  @@index([status])
  @@map("gun_status_snapshots")
}


// ---------------- USER CHECK-INS ----------------
model UserCheckIn {
  id         String   @id @default(auto()) @map("_id") @mongo.ObjectId
  userId     String
  stationId String
  gunId      String?
  status     String        // WORKING | ICE_BLOCKED | OFFLINE | OCCUPIED
  confidence Int           // 1â€“5
  source     String        // APP | RFID | AUTO
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([stationId, createdAt(sort: Desc)])
  @@index([gunId, createdAt(sort: Desc)])
  @@map("user_checkins")
}
